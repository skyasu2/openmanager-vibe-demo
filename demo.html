<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenManager 7.0 - 자연어 기반 서버 분석</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* ... (이전 답변의 demo.html 스타일 대부분 유지) ... */
        body { font-family: 'Malgun Gothic', 'Segoe UI', sans-serif; margin: 0; padding: 0; color: #333; background-color: #f5f7fa; }
        .header { background-color: #2c3e50; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 20px; font-weight: bold; }
        .nav-menu { display: flex; }
        .nav-item { padding: 8px 15px; margin-left: 5px; color: white; text-decoration: none; border-radius: 4px; }
        .nav-item.active { background-color: #3498db; }
        .container { max-width: 1300px; margin: 20px auto; padding: 20px; background-color: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2, h3 { color: #2c3e50; }
        h1 { text-align: center; margin-bottom: 5px;}
        h2 { border-bottom: 1px solid #eee; padding-bottom: 10px; margin-top: 30px; margin-bottom: 20px; font-size: 1.3em; }
        .timestamp { text-align: center; color: #7f8c8d; margin-bottom: 25px; font-size: 0.9em; }
        
        .nlp-section { background-color: #eaf5ff; padding: 20px; border-radius: 6px; margin-bottom: 25px; border: 1px solid #cce0ff;}
        .nlp-section h3 { margin-top: 0; color: #0056b3; border-bottom-color: #add8e6; }
        .nlp-input-group { display: flex; gap: 10px; margin-bottom: 10px; align-items: center;}
        #nlp-query-input { flex-grow: 1; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; font-size: 0.95em;}
        #nlp-query-select { padding: 10px; border: 1px solid #ced4da; border-radius: 4px; background-color: white; font-size: 0.95em; min-width: 200px;}
        #nlp-submit-btn { padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.3s; font-size: 0.95em;}
        #nlp-submit-btn:hover { background-color: #0056b3; }
        .nlp-result-explanation { background-color: #f8f9fa; padding: 10px; border-radius: 4px; font-size: 0.85em; color: #495057; margin-bottom: 15px; border: 1px dashed #ced4da;}
        
        .filters-section { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 25px; padding: 15px; background-color: #f9f9f9; border-radius: 6px; align-items: center; }
        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { font-size: 0.85em; margin-bottom: 5px; color: #555; }
        .filter-select { padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; background-color: white; min-width: 160px; }
        .filter-btn { padding: 9px 18px; background-color: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; height: 38px; align-self: flex-end; }
        .filter-btn:hover { background-color: #2980b9; }

        .resource-sections-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .resource-section, .problem-section, .nlp-summary-section { background-color: #fff; padding: 15px 20px; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); border: 1px solid #e9ecef; }
        .resource-section h3, .problem-section h3, .nlp-summary-section h3 { margin-top: 0; margin-bottom: 15px; color: #34495e; border-bottom: 2px solid #3498db; padding-bottom: 10px; font-size: 1.1em; font-weight: 600; }
        
        .server-list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 5px; border-bottom: 1px dashed #ecf0f1; font-size: 0.9em; transition: background-color 0.2s ease-in-out; }
        .server-list-item:hover { background-color: #f8f9fa; }
        .server-list-item:last-child { border-bottom: none; }
        .server-name { font-weight: 600; color: #2c3e50; flex-basis: 55%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .server-name[title] { cursor: help; }
        .server-usage { color: #2980b9; font-weight: 500; flex-basis: 40%; text-align: right; }
        
        .problem-item .server-name, .nlp-summary-item .server-name { display: block; margin-bottom: 3px;}
        .problem-item .server-alerts, .nlp-summary-item .server-details { font-size: 0.8em; color: #7f8c8d; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; display: block; }
        .nlp-summary-item .server-details { color: #555; } /* NLP 결과 상세 내용 색상 변경 */
        .problem-item .server-alerts[title], .nlp-summary-item .server-details[title] { cursor: help; }
        .problem-item .problem-score, .nlp-summary-item .nlp-relevance-score { font-size: 0.95em; color: #e74c3c; font-weight: bold; white-space: nowrap; }
        .problem-item, .nlp-summary-item { cursor: pointer; }

        .report-button { background-color: #17a2b8; color: white; padding: 6px 12px; font-size: 0.8em; border:none; border-radius: 4px; cursor: pointer; margin-top: 8px; display: inline-block;}
        .report-button:hover { background-color: #138496; }

        .modal { display: none; position: fixed; z-index: 10001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 25px; border: 1px solid #888; width: 70%; max-width: 800px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative; }
        .modal-close { color: #aaa; float: right; font-size: 28px; font-weight: bold; position: absolute; top: 10px; right: 20px; }
        .modal-close:hover, .modal-close:focus { color: black; text-decoration: none; cursor: pointer; }
        .modal-content h4 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom:10px; }
        .modal-content pre { background-color: #f8f9fa; padding: 15px; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word; font-size: 0.9em; max-height: 400px; overflow-y: auto; }


        .csv-btn { margin-top: 20px; display: inline-block; padding: 10px 20px; background-color: #2ecc71; color: white; text-decoration: none; border-radius: 4px; font-size: 0.9em; cursor: pointer; border: none; transition: background-color 0.3s; }
        .csv-btn:hover { background-color: #27ae60; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.85); display: none; justify-content: center; align-items: center; z-index: 10000; }
        .loading-spinner { border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <div id="report-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" id="modal-close-btn">&times;</span>
            <h4 id="report-title">분석 보고서</h4>
            <div id="report-body">
                <pre id="report-text-content"></pre>
            </div>
        </div>
    </div>


    <header class="header">
        <div class="logo">OpenManager 7.0</div>
        <nav class="nav-menu">
            <a href="index.html" class="nav-item">소개</a>
            <a href="demo.html" class="nav-item active">자연어 기반 서버 분석</a>
        </nav>
    </header>

    <div class="container">
        <h1>자연어 기반 서버 분석</h1>
        <div class="timestamp" id="timestamp">데이터 기준 시각: 로딩 중...</div>

        <section class="nlp-section">
            <h3>질의를 통해 서버 경고 요약하기</h3>
            <div class="nlp-input-group">
                <input type="text" id="nlp-query-input" placeholder="예: CPU 사용률 높은 서버 찾아줘">
                <select id="nlp-query-select">
                    <option value="">-- 예시 질문 선택 --</option>
                    <option data-report-type="cpu" value="CPU 사용률이 가장 높은 서버 3대는?">CPU 사용률 TOP3 서버</option>
                    <option data-report-type="critical_error" value="Critical 상태인 DB 서버 목록">Critical 상태 DB 서버</option>
                    <option data-report-type="memory" value="최근 1시간 동안 '메모리 부족' 경고가 발생한 WAS 서버">최근 1시간 메모리 부족 WAS 서버</option>
                    <option data-report-type="error_status" value="Seoul-IDC 위치의 서버 중 Error 상태인 서버는?">Seoul-IDC Error 서버</option>
                    <option data-report-type="network" value="네트워크 트래픽이 많은 서버는?">네트워크 트래픽 TOP 서버</option>
                    <option data-report-type="disk" value="디스크 공간 부족 경고가 있는 서버">디스크 공간 부족 서버</option>
                    <option data-report-type="generic_problem" value="어제부터 문제 있는 서버들 요약해줘">어제부터 문제 서버 요약</option>
                </select>
                <button id="nlp-submit-btn">질의 실행</button>
            </div>
            <div class="nlp-result-explanation" id="nlp-explanation">
                <strong>해석된 조건:</strong> (여기에 자연어 질의 해석 결과가 표시됩니다)
            </div>
        </section>

        <section class="nlp-summary-section">
            <h3>자연어 질의 결과 요약</h3>
            <div id="nlp-summary-list">
                </div>
            <div id="nlp-report-button-container" style="margin-top: 15px; text-align: right;">
                </div>
        </section>

        <hr style="margin: 30px 0;">

        <h2>기존 필터 기반 분석 (참고용)</h2>
        <div class="filters-section">
            <div class="filter-group">
                <label for="time-filter">시간 범위:</label>
                <select class="filter-select" id="time-filter">
                    <option value="1">최근 1시간</option> <option value="6">최근 6시간</option>
                    <option value="24" selected>최근 24시간</option> <option value="72">최근 3일</option>
                    <option value="168">최근 7일</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="server-type-filter">서버 유형:</label>
                <select class="filter-select" id="server-type-filter">
                    <option value="all">모든 서버 유형</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="location-filter">위치:</label>
                <select class="filter-select" id="location-filter">
                    <option value="all">모든 위치</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="alert-filter">문제 분석용 경고 필터:</label>
                <select class="filter-select" id="alert-filter">
                    <option value="all">모든 경고 (문제분석용)</option>
                    <option value="Critical">심각(Critical)만</option>
                    <option value="Error">오류(Error)만</option>
                    <option value="Warning">주의(Warning)만</option>
                </select>
            </div>
            <button class="filter-btn" id="apply-filter-btn">필터 적용 (참고용)</button>
        </div>

        <h2>리소스 사용률 TOP 5 (참고용)</h2>
        <div class="resource-sections-grid">
            <div class="resource-section" id="cpu-top-section"><h3>CPU 사용률 TOP 5</h3><div id="cpu-top-list"></div></div>
            <div class="resource-section" id="memory-top-section"><h3>메모리 사용률 TOP 5</h3><div id="memory-top-list"></div></div>
            <div class="resource-section" id="disk-top-section"><h3>디스크 사용률 TOP 5</h3><div id="disk-top-list"></div></div>
            <div class="resource-section" id="network-top-section"><h3>네트워크 트래픽 TOP 5</h3><div id="network-top-list"></div></div>
        </div>

        <div class="problem-section">
            <h3>주요 문제 발생 서버 TOP 5 (필터 기반 분석 결과)</h3>
            <div id="problematic-servers-list"></div>
        </div>

        <button class="csv-btn" id="download-csv-btn">종합 요약 CSV 다운로드</button>

    </div>

    <script src="fixed_dummy_data.js"></script>
    <script src="data_processor.js"></script>
    <script>
        // --- 전역 변수 및 기본 함수 ---
        let allServerData = [];
        let dataProcessor = null;
        const loadingOverlay = document.getElementById('loading-overlay');
        const reportModal = document.getElementById('report-modal');
        const reportTitleEl = document.getElementById('report-title');
        const reportTextContentEl = document.getElementById('report-text-content');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        function showLoading() { if (loadingOverlay) loadingOverlay.style.display = 'flex'; }
        function hideLoading() { if (loadingOverlay) loadingOverlay.style.display = 'none'; }

        function populateDropdown(selectElement, optionsArray, defaultOptionText) { /* 이전과 동일 */
            if (!selectElement) { console.error("Dropdown element not found for: " + defaultOptionText); return; }
            selectElement.innerHTML = `<option value="all">${defaultOptionText}</option>`;
            (optionsArray || []).forEach(optionValue => {
                const option = document.createElement('option');
                option.value = optionValue; option.textContent = optionValue;
                selectElement.appendChild(option);
            });
        }
        
        function initializeLegacyFilters() { /* 이전과 동일 */
            if (!dataProcessor) { console.error("DataProcessor not ready for initializing filters."); return; }
            populateDropdown(document.getElementById('server-type-filter'), dataProcessor.getUniqueServerTypes(), '모든 서버 유형');
            populateDropdown(document.getElementById('location-filter'), dataProcessor.getUniqueLocations(), '모든 위치');
            
            const alertFilterEl = document.getElementById('alert-filter');
            const uniqueAlertTypes = dataProcessor.getUniqueAlertTypes();
            if (alertFilterEl && uniqueAlertTypes) {
                uniqueAlertTypes.forEach(alertType => {
                    if (!['Critical', 'Error', 'Warning', 'Info'].includes(alertType)) {
                        const option = document.createElement('option');
                        option.value = alertType; option.textContent = `${alertType} 관련 경고`;
                        alertFilterEl.appendChild(option);
                    }
                });
            }
        }

        function renderTopResourceList(listElementId, servers) { /* 이전과 동일 */
            const listElement = document.getElementById(listElementId);
            if (!listElement) { console.error(`Element with ID '${listElementId}' not found.`); return; }
            listElement.innerHTML = '';
            if (!servers || servers.length === 0) {
                listElement.innerHTML = '<p style="font-size:0.85em; color:#777; text-align:center; padding-top:20px;">데이터 없음</p>';
                return;
            }
            servers.forEach(server => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'server-list-item';
                itemDiv.innerHTML = `
                    <span class="server-name" title="타입: ${server.type || 'N/A'} | 위치: ${server.location || 'N/A'}">${(server.name || 'N/A').split('.')[0]}</span>
                    <span class="server-usage">${(server.avgUsage !== undefined ? server.avgUsage.toFixed(1) : 'N/A')}${server.unit || ''}</span>
                `;
                listElement.appendChild(itemDiv);
            });
        }

        function renderProblematicServersList(servers) { /* 이전과 동일 */
             const listElement = document.getElementById('problematic-servers-list');
            if (!listElement) { console.error("Element with ID 'problematic-servers-list' not found."); return; }
            listElement.innerHTML = '';
            if (!servers || servers.length === 0) {
                listElement.innerHTML = '<p style="font-size:0.85em; color:#777; text-align:center; padding-top:20px;">주요 문제 발생 서버 없음</p>';
                return;
            }
            servers.forEach(server => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'server-list-item problem-item';
                itemDiv.innerHTML = `
                    <div>
                        <span class="server-name" title="타입: ${server.type || 'N/A'} | 위치: ${server.location || 'N/A'}">${(server.name || 'N/A').split('.')[0]}</span>
                        <div class="server-alerts" title="${server.recentProblemMessages || ''}">${server.recentProblemMessages || '상세 정보 확인 필요'}</div>
                    </div>
                    <span class="problem-score">Score: ${server.score || 0} (C:${server.criticalAlertCount || 0}/E:${server.errorAlertCount || 0}/W:${server.warningAlertCount || 0})</span>
                `;
                itemDiv.addEventListener('click', () => {
                    alert(`서버: ${server.name || 'N/A'}\n타입: ${server.type || 'N/A'}\n위치: ${server.location || 'N/A'}\n문제 점수: ${server.score || 0}\n최근 문제 요약: ${server.recentProblemMessages || '없음'}`);
                });
                listElement.appendChild(itemDiv);
            });
        }

        // --- 보고서 생성 및 표시 ---
        function generatePredefinedReport(reportType, query, filteredNlpData) {
            let reportTitle = "분석 보고서";
            let reportContent = `"${query}"에 대한 분석 결과입니다.\n\n`;

            const topProblemServer = filteredNlpData && filteredNlpData.length > 0 ? filteredNlpData[0] : null;

            switch(reportType) {
                case 'cpu':
                    reportTitle = "CPU 사용률 상세 분석 보고서";
                    reportContent += "최근 CPU 사용률이 높은 서버들에 대한 분석입니다.\n";
                    if (topProblemServer) {
                        reportContent += `- 주요 문제 서버: ${topProblemServer.name} (현재 점수: ${topProblemServer.score})\n`;
                        reportContent += `  - 서버 타입: ${topProblemServer.type}, 위치: ${topProblemServer.location}\n`;
                        reportContent += `  - 최근 관련 경고: ${topProblemServer.recentProblemMessages}\n`;
                    }
                    reportContent += "\nCPU 사용률 TOP3 서버 (평균 기준):\n";
                    const cpuTop3 = dataProcessor.getTopNServersByResource(allServerData, 'cpu', 3); // 전체 데이터에서 TOP3
                    cpuTop3.forEach((s,idx) => reportContent += `${idx+1}. ${s.name} (${s.avgUsage}%)\n`);
                    reportContent += "\n조치 권고:\n1. 해당 서버들의 상세 CPU 사용량 변화 추이 확인 (시간별, 일별).\n2. CPU 점유율이 높은 프로세스 특정.\n3. 불필요한 프로세스 종료 또는 리소스 최적화 고려.\n4. 지속적인 문제 발생 시 스케일업 또는 아키텍처 검토 필요.";
                    break;
                case 'memory':
                    reportTitle = "메모리 사용 현황 분석 보고서";
                    reportContent += "메모리 관련 문제 발생 서버 및 사용률 높은 서버 분석입니다.\n";
                     if (topProblemServer) {
                        reportContent += `- 주요 문제 서버: ${topProblemServer.name} (현재 점수: ${topProblemServer.score})\n`;
                        reportContent += `  - 서버 타입: ${topProblemServer.type}, 위치: ${topProblemServer.location}\n`;
                        reportContent += `  - 최근 관련 경고: ${topProblemServer.recentProblemMessages}\n`;
                    }
                    reportContent += "\n메모리 사용률 TOP3 서버 (평균 기준):\n";
                    const memTop3 = dataProcessor.getTopNServersByResource(allServerData, 'memory', 3);
                    memTop3.forEach((s,idx) => reportContent += `${idx+1}. ${s.name} (${s.avgUsage}%)\n`);
                    reportContent += "\n조치 권고:\n1. 메모리 누수(Leak) 가능성 점검.\n2. JVM Heap Dump 분석 (Java 애플리케이션의 경우).\n3. 불필요한 캐시 정리 및 리소스 최적화.\n4. 메모리 증설 또는 서비스 분산 고려.";
                    break;
                case 'disk':
                    reportTitle = "디스크 사용 현황 분석 보고서";
                    // ... (디스크 관련 보고서 내용)
                    reportContent += "디스크 관련 문제 및 사용률 분석입니다.\n(보고서 내용 추가 예정)";
                    break;
                case 'network':
                    reportTitle = "네트워크 트래픽 분석 보고서";
                    // ... (네트워크 관련 보고서 내용)
                    reportContent += "네트워크 트래픽 및 관련 문제 분석입니다.\n(보고서 내용 추가 예정)";
                    break;
                case 'critical_error':
                case 'error_status':
                    reportTitle = "주요 오류 및 장애 분석 보고서";
                     if (topProblemServer) {
                        reportContent += `"${query}" 조건에 부합하는 주요 문제 서버: ${topProblemServer.name} (점수: ${topProblemServer.score})\n`;
                        reportContent += `- 서버 상세: ${topProblemServer.type} @ ${topProblemServer.location}\n`;
                        reportContent += `- 발생 문제 요약: ${topProblemServer.recentProblemMessages}\n\n`;
                        reportContent += `상세 분석:\n해당 서버는 Critical 또는 Error 상태로 식별되었으며, 주요 경고는 다음과 같습니다...\n(추가적인 상세 로그나 시간대별 이벤트 나열 - 더미)\n- 2025-05-14 02:10:00: ${topProblemServer.name} - ${topProblemServer.recentProblemMessages.split('|')[0]}\n- 2025-05-14 01:55:00: ${topProblemServer.name} - 상태 Critical 변경 감지\n`;
                    } else {
                        reportContent += "해당 조건에 맞는 주요 문제 서버를 찾지 못했습니다.\n";
                    }
                    reportContent += "\n조치 권고:\n1. 즉시 해당 서버 접속하여 시스템 로그 및 애플리케이션 로그 확인.\n2. 관련 서비스 영향도 파악 및 긴급 복구 절차 진행.\n3. 근본 원인 분석 및 재발 방지 대책 수립.";
                    break;
                default: // generic_problem 또는 기타
                    reportTitle = "종합 문제 분석 보고서";
                    reportContent += `"${query}" 관련 종합 분석입니다.\n`;
                    if (filteredNlpData && filteredNlpData.length > 0) {
                        reportContent += "다음 서버들에서 문제점이 관찰되었습니다:\n";
                        filteredNlpData.slice(0,3).forEach(s => { // 상위 3개 서버 정보
                            reportContent += `- ${s.name} (타입: ${s.type}, 위치: ${s.location}, 점수: ${s.score})\n   주요 문제: ${s.recentProblemMessages}\n`;
                        });
                    } else {
                        reportContent += "특별한 문제점이 감지되지 않았습니다.\n";
                    }
                    reportContent += "\n권고 사항: 지속적인 모니터링 및 임계치 관리 필요.";
            }
            return { title: reportTitle, content: reportContent };
        }

        function showReportModal(title, content) {
            if (reportModal && reportTitleEl && reportTextContentEl) {
                reportTitleEl.textContent = title;
                reportTextContentEl.textContent = content;
                reportModal.style.display = "block";
            }
        }

        // --- 자연어 처리 및 결과 표시 함수 ---
        function interpretAndExecuteNLPQuery(query) {
            showLoading();
            const explanationEl = document.getElementById('nlp-explanation');
            const resultListEl = document.getElementById('nlp-summary-list');
            const reportButtonContainer = document.getElementById('nlp-report-button-container');
            resultListEl.innerHTML = '';
            reportButtonContainer.innerHTML = ''; // 이전 보고서 버튼 제거

            let timeRange = 24; let serverType = 'all'; let alertFilter = 'all'; let location = 'all';
            let interpretation = `입력 질의: "${query}"\n`;
            let detectedReportType = 'generic_problem'; // 기본 보고서 타입

            // 예시 질문 선택 시 data-report-type 가져오기
            const selectedOption = document.querySelector(`#nlp-query-select option[value="${query}"]`);
            if (selectedOption && selectedOption.dataset.reportType) {
                detectedReportType = selectedOption.dataset.reportType;
            }


            if (query.includes("최근 1시간")) { timeRange = 1; interpretation += "시간: 최근 1시간, ";}
            // ... (더 많은 단순 키워드 해석 로직 추가) ...
            else if (query.toLowerCase().includes("cpu")) { alertFilter = 'CPU'; interpretation += "경고타입: CPU, "; detectedReportType = 'cpu'; }
            else if (query.toLowerCase().includes("메모리") || query.toLowerCase().includes("memory")) { alertFilter = 'Memory'; interpretation += "경고타입: Memory, "; detectedReportType = 'memory'; }
            else if (query.toLowerCase().includes("디스크") || query.toLowerCase().includes("disk")) { alertFilter = 'Disk'; interpretation += "경고타입: Disk, "; detectedReportType = 'disk'; }
            else if (query.toLowerCase().includes("네트워크") || query.toLowerCase().includes("network")) { alertFilter = 'Network'; interpretation += "경고타입: Network, "; detectedReportType = 'network'; }
            else if (query.toLowerCase().includes("critical") || query.includes("심각")) { alertFilter = 'Critical'; interpretation += "심각도: Critical, "; detectedReportType = 'critical_error';}
            else if (query.toLowerCase().includes("error") || query.includes("오류")) { alertFilter = 'Error'; interpretation += "심각도: Error, "; detectedReportType = 'error_status';}


            const serverTypes = dataProcessor.getUniqueServerTypes();
            for (const type of serverTypes) { if (query.toUpperCase().includes(type)) { serverType = type; interpretation += `서버타입: ${type}, `; break; } }
            const locations = dataProcessor.getUniqueLocations();
            for (const loc of locations) { if (query.includes(loc)) { location = loc; interpretation += `위치: ${loc}, `; break; } }
            
            explanationEl.innerHTML = `<strong>해석된 조건:</strong> ${interpretation.length > `입력 질의: "${query}"\n`.length ? interpretation.split('\n').slice(1).join('') : "일반 요약"}`;

            setTimeout(() => {
                try {
                    const filteredNlpData = dataProcessor.applyFilters(timeRange, serverType, alertFilter, location);
                    const nlpSummary = dataProcessor.getProblematicServersSummary(filteredNlpData, 5);

                    if (!nlpSummary || nlpSummary.length === 0) {
                        resultListEl.innerHTML = `<p style="font-size:0.85em; color:#777;">"${query}"에 대한 요약 결과가 없습니다.</p>`;
                    } else {
                        nlpSummary.forEach(server => { /* ... (이전과 동일하게 nlp-summary-item 생성) ... */
                            const itemDiv = document.createElement('div');
                            itemDiv.className = 'server-list-item nlp-summary-item';
                            itemDiv.innerHTML = `
                                <div>
                                    <span class="server-name" title="타입: ${server.type || 'N/A'} | 위치: ${server.location || 'N/A'}">${(server.name || 'N/A').split('.')[0]}</span>
                                    <div class="server-details" title="${server.recentProblemMessages || ''}">${server.recentProblemMessages || '문제 상세 정보 없음'}</div>
                                </div>
                                <span class="nlp-relevance-score">분석점수: ${server.score || 0}</span>
                            `;
                            itemDiv.addEventListener('click', () => alert(`서버: ${server.name}\n문제 점수: ${server.score}\n상세: ${server.recentProblemMessages}`));
                            resultListEl.appendChild(itemDiv);
                        });

                        // 보고서 생성 버튼 추가
                        const reportButton = document.createElement('button');
                        reportButton.className = 'report-button';
                        reportButton.textContent = `${detectedReportType.toUpperCase()} 분석 보고서 생성`;
                        reportButton.onclick = function() {
                            const report = generatePredefinedReport(detectedReportType, query, nlpSummary);
                            showReportModal(report.title, report.content);
                        };
                        reportButtonContainer.appendChild(reportButton);
                    }
                    explanationEl.innerHTML += `<br><br><strong>LLM 활용 방안 (데모 안내):</strong> 현재는 단순 키워드 매칭으로 동작합니다. 실제 LLM 연동 시 더욱 정교한 분석이 가능합니다.`;
                } catch (e) {
                    console.error("NLP 질의 처리 중 오류:", e);
                    resultListEl.innerHTML = `<p style="color:red;">질의 처리 중 오류가 발생했습니다.</p>`;
                } finally {
                    hideLoading();
                }
            }, 500);
        }

        // --- 기존 필터 기반 분석 함수 ---
        function applyAndRenderLegacyFilters() { /* 이전과 동일 */
             showLoading();
            setTimeout(() => {
                try {
                    if (!dataProcessor) { hideLoading(); return; }
                    const timeRange = document.getElementById('time-filter').value;
                    const serverType = document.getElementById('server-type-filter').value;
                    const alertForProblemAnalysis = document.getElementById('alert-filter').value;
                    const location = document.getElementById('location-filter').value;

                    const baseFilteredData = dataProcessor.applyFilters(parseInt(timeRange), serverType, 'all', location);
                    renderTopResourceList('cpu-top-list', dataProcessor.getTopNServersByResource(baseFilteredData, 'cpu'));
                    renderTopResourceList('memory-top-list', dataProcessor.getTopNServersByResource(baseFilteredData, 'memory'));
                    renderTopResourceList('disk-top-list', dataProcessor.getTopNServersByResource(baseFilteredData, 'disk'));
                    renderTopResourceList('network-top-list', dataProcessor.getTopNServersByResource(baseFilteredData, 'network'));
                    
                    const problemFilteredData = dataProcessor.applyFilters(parseInt(timeRange), serverType, alertForProblemAnalysis, location);
                    renderProblematicServersList(dataProcessor.getProblematicServersSummary(problemFilteredData));

                    updateTimestamp();
                } catch (error) {
                    console.error('기존 필터 적용 및 렌더링 오류:', error);
                } finally {
                    hideLoading();
                }
            }, 50);
        }
        
        function updateTimestamp() { /* 이전과 동일 */
            const timestampEl = document.getElementById('timestamp');
            if (timestampEl) {
                const dataEndTime = allServerData && allServerData.length > 0 ? new Date(Math.max(...allServerData.map(d => new Date(d.timestamp).getTime()))) : new Date();
                timestampEl.textContent = `데이터 기준 시각: ${dataEndTime.toLocaleString('ko-KR', { year: 'numeric', month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: false })}`;
            }
        }

        function setupEventListeners() { /* 이전과 동일, 모달 닫기 버튼 추가 */
             const nlpInput = document.getElementById('nlp-query-input');
             const nlpSelect = document.getElementById('nlp-query-select');
             const nlpSubmitBtn = document.getElementById('nlp-submit-btn');

             if(nlpSelect) {
                nlpSelect.addEventListener('change', function() {
                    if (this.value) {
                        nlpInput.value = this.value;
                        // 선택 시 바로 질의 실행도 가능
                        // const query = nlpInput.value.trim();
                        // if (query) interpretAndExecuteNLPQuery(query);
                    }
                });
             }
             if(nlpSubmitBtn) {
                nlpSubmitBtn.addEventListener('click', function() {
                    const query = nlpInput.value.trim();
                    if (query) interpretAndExecuteNLPQuery(query);
                    else alert("질의를 입력하거나 예시를 선택해주세요.");
                });
             }
             if(nlpInput) {
                 nlpInput.addEventListener('keypress', function(e) {
                     if (e.key === 'Enter') {
                         const query = nlpInput.value.trim();
                         if (query) interpretAndExecuteNLPQuery(query);
                         e.preventDefault(); // Enter키 기본 동작 방지
                     }
                 });
             }

             const legacyApplyBtn = document.getElementById('apply-filter-btn');
             if(legacyApplyBtn) legacyApplyBtn.addEventListener('click', applyAndRenderLegacyFilters);
             
             const csvBtn = document.getElementById('download-csv-btn');
             if(csvBtn) csvBtn.addEventListener('click', downloadCombinedCSV);

             if(modalCloseBtn) {
                modalCloseBtn.onclick = function() {
                    if(reportModal) reportModal.style.display = "none";
                }
             }
             // 모달 외부 클릭 시 닫기 (선택 사항)
             window.onclick = function(event) {
                if (event.target == reportModal) {
                    if(reportModal) reportModal.style.display = "none";
                }
             }
        }

        function downloadCombinedCSV() { /* 이전과 동일 */
            showLoading();
            try {
                if (!dataProcessor) { alert("데이터 미로드"); hideLoading(); return; }
                const timeRange = document.getElementById('time-filter').value;
                const serverType = document.getElementById('server-type-filter').value;
                const locationVal = document.getElementById('location-filter').value;
                const alertForProblemAnalysis = document.getElementById('alert-filter').value;

                const baseFilteredData = dataProcessor.applyFilters(parseInt(timeRange), serverType, 'all', locationVal);
                const problemFilteredData = dataProcessor.applyFilters(parseInt(timeRange), serverType, alertForProblemAnalysis, locationVal);

                let csvContent = "항목,서버명,서버타입,위치,값/점수,단위/상세정보\n";
                
                const resources = [
                    {key: 'cpu', name: 'CPU 사용률 TOP5'}, {key: 'memory', name: '메모리 사용률 TOP5'},
                    {key: 'disk', name: '디스크 사용률 TOP5'}, {key: 'network', name: '네트워크 트래픽 TOP5'}
                ];
                resources.forEach(res => {
                    const topServers = dataProcessor.getTopNServersByResource(baseFilteredData, res.key);
                    (topServers || []).forEach(s => {
                        csvContent += `"${res.name}","${s.name || ''}","${s.type || ''}","${s.location || ''}",${s.avgUsage !== undefined ? s.avgUsage.toFixed(1) : ''},"${s.unit || ''}"\n`;
                    });
                });

                const problemServers = dataProcessor.getProblematicServersSummary(problemFilteredData);
                (problemServers || []).forEach(s => {
                    const details = `C:${s.criticalAlertCount || 0}/E:${s.errorAlertCount || 0}/W:${s.warningAlertCount || 0} | ${(s.recentProblemMessages || '').replace(/"/g, '""')}`;
                    csvContent += `"문제서버 TOP5","${s.name || ''}","${s.type || ''}","${s.location || ''}",${s.score || 0},"${details}"\n`;
                });

                const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", `OpenManager_분석요약_${new Date().toISOString().slice(0,10)}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

            } catch (error) {
                console.error('CSV 다운로드 오류:', error);
            } finally {
                hideLoading();
            }
        }

        // --- 페이지 초기화 ---
        document.addEventListener('DOMContentLoaded', function() {
            showLoading();
            try {
                if (typeof getFixedDummyData !== 'function' ) {
                    console.error("getFixedDummyData is not defined!"); alert("데이터 생성 스크립트 오류."); hideLoading(); return;
                }
                allServerData = getFixedDummyData();
                console.log(`고정 더미 데이터 ${allServerData.length}개 로드 완료.`);

                if (!allServerData || allServerData.length === 0) {
                     alert("로드된 서버 데이터가 없습니다."); hideLoading(); return;
                }
                
                if (typeof ServerDataProcessor !== 'function') {
                    console.error("ServerDataProcessor is not defined!"); alert("데이터 처리 스크립트 오류."); hideLoading(); return;
                }
                dataProcessor = new ServerDataProcessor(allServerData);
                console.log('DataProcessor 초기화 완료.');
                
                initializeLegacyFilters(); 
                applyAndRenderLegacyFilters(); 
                setupEventListeners();

            } catch (error) {
                console.error('페이지 초기화 중 오류:', error);
                alert('페이지 초기화 중 오류 발생. 콘솔 확인.');
            } finally {
                hideLoading(); 
            }
        });
    </script>
</body>
</html>
