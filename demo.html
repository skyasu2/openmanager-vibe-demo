<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenManager 7.0 - 자연어 기반 서버 분석</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* demo.html 특정 스타일 */
        body { font-family: 'Malgun Gothic', 'Segoe UI', sans-serif; margin: 0; padding: 0; color: #333; background-color: #f5f7fa; }
        .header { background-color: #2c3e50; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 20px; font-weight: bold; }
        .nav-menu { display: flex; }
        .nav-item { padding: 8px 15px; margin-left: 5px; color: white; text-decoration: none; border-radius: 4px; }
        .nav-item.active { background-color: #3498db; }
        .container { max-width: 1300px; margin: 20px auto; padding: 20px; background-color: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2, h3 { color: #2c3e50; }
        h1 { text-align: center; margin-bottom: 5px;}
        h2 { border-bottom: 1px solid #eee; padding-bottom: 10px; margin-top: 30px; margin-bottom: 20px; font-size: 1.3em; }
        .timestamp { text-align: center; color: #7f8c8d; margin-bottom: 25px; font-size: 0.9em; }
        
        /* NLP 섹션 스타일 */
        .nlp-section { background-color: #eaf5ff; padding: 20px; border-radius: 6px; margin-bottom: 25px; border: 1px solid #cce0ff;}
        .nlp-section h3 { margin-top: 0; color: #0056b3; border-bottom-color: #add8e6; }
        .nlp-input-group { display: flex; gap: 10px; margin-bottom: 10px; align-items: center;}
        #nlp-query-input { flex-grow: 1; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; font-size: 0.95em;}
        #nlp-query-select { padding: 10px; border: 1px solid #ced4da; border-radius: 4px; background-color: white; font-size: 0.95em; min-width: 200px;}
        #nlp-submit-btn { padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.3s; font-size: 0.95em;}
        #nlp-submit-btn:hover { background-color: #0056b3; }
        .nlp-result-explanation { background-color: #f8f9fa; padding: 10px; border-radius: 4px; font-size: 0.85em; color: #495057; margin-bottom: 15px; border: 1px dashed #ced4da;}
        
        /* 기존 필터 섹션 스타일 */
        .filters-section { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 25px; padding: 15px; background-color: #f9f9f9; border-radius: 6px; align-items: center; }
        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { font-size: 0.85em; margin-bottom: 5px; color: #555; }
        .filter-select { padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; background-color: white; min-width: 160px; }
        .filter-btn { padding: 9px 18px; background-color: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; height: 38px; align-self: flex-end; }
        .filter-btn:hover { background-color: #2980b9; }

        /* 결과 표시 섹션 스타일 */
        .resource-sections-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .resource-section, .problem-section, .nlp-summary-section { background-color: #fff; padding: 15px 20px; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); border: 1px solid #e9ecef; }
        .resource-section h3, .problem-section h3, .nlp-summary-section h3 { margin-top: 0; margin-bottom: 15px; color: #34495e; border-bottom: 2px solid #3498db; padding-bottom: 10px; font-size: 1.1em; font-weight: 600; }
        
        .server-list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 5px; border-bottom: 1px dashed #ecf0f1; font-size: 0.9em; transition: background-color 0.2s ease-in-out; }
        .server-list-item:hover { background-color: #f8f9fa; }
        .server-list-item:last-child { border-bottom: none; }
        .server-name { font-weight: 600; color: #2c3e50; flex-basis: 55%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .server-name[title] { cursor: help; }
        .server-usage { color: #2980b9; font-weight: 500; flex-basis: 40%; text-align: right; }
        
        .problem-item .server-name, .nlp-summary-item .server-name { display: block; margin-bottom: 3px;}
        .problem-item .server-alerts, .nlp-summary-item .server-details { font-size: 0.8em; color: #7f8c8d; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; display: block; }
        .nlp-summary-item .server-details { color: #555; } 
        .problem-item .server-alerts[title], .nlp-summary-item .server-details[title] { cursor: help; }
        .problem-item .problem-score, .nlp-summary-item .nlp-relevance-score { font-size: 0.95em; color: #e74c3c; font-weight: bold; white-space: nowrap; }
        .problem-item, .nlp-summary-item { cursor: pointer; }

        /* 보고서 버튼 및 모달 스타일 */
        .report-button { background-color: #17a2b8; color: white; padding: 6px 12px; font-size: 0.8em; border:none; border-radius: 4px; cursor: pointer; margin-top: 8px; display: inline-block;}
        .report-button:hover { background-color: #138496; }
        .modal { display: none; position: fixed; z-index: 10001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 25px; border: 1px solid #888; width: 70%; max-width: 800px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative; }
        .modal-close { color: #aaa; float: right; font-size: 28px; font-weight: bold; position: absolute; top: 10px; right: 20px; }
        .modal-close:hover, .modal-close:focus { color: black; text-decoration: none; cursor: pointer; }
        .modal-content h4 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom:10px; }
        .modal-content pre { background-color: #f8f9fa; padding: 15px; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word; font-size: 0.9em; max-height: 400px; overflow-y: auto; }

        /* 기타 유틸리티 스타일 */
        .csv-btn { margin-top: 20px; display: inline-block; padding: 10px 20px; background-color: #2ecc71; color: white; text-decoration: none; border-radius: 4px; font-size: 0.9em; cursor: pointer; border: none; transition: background-color 0.3s; }
        .csv-btn:hover { background-color: #27ae60; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.85); display: none; justify-content: center; align-items: center; z-index: 10000; }
        .loading-spinner { border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <div id="report-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" id="modal-close-btn">&times;</span>
            <h4 id="report-title">분석 보고서</h4>
            <div id="report-body">
                <pre id="report-text-content"></pre> </div>
        </div>
    </div>

    <header class="header">
        <div class="logo">OpenManager 7.0</div>
        <nav class="nav-menu">
            <a href="index.html" class="nav-item">소개</a>
            <a href="demo.html" class="nav-item active">자연어 기반 서버 분석</a>
        </nav>
    </header>

    <div class="container">
        <h1>자연어 기반 서버 분석</h1>
        <div class="timestamp" id="timestamp">데이터 기준 시각: 로딩 중...</div>

        <section class="nlp-section">
            <h3>질의를 통해 서버 경고 요약하기</h3>
            <div class="nlp-input-group">
                <input type="text" id="nlp-query-input" placeholder="예: CPU 사용률 높은 서버 찾아줘">
                <select id="nlp-query-select">
                    <option value="">-- 예시 질문 선택 --</option>
                    <option data-report-type="cpu" value="CPU 사용률이 가장 높은 서버 3대는?">CPU 사용률 TOP3 서버</option>
                    <option data-report-type="memory" value="메모리 사용량이 많은 서버는 어디인가요?">메모리 사용량 TOP 서버</option>
                    <option data-report-type="disk" value="디스크 공간이 부족한 서버 목록">디스크 공간 부족 서버</option>
                    <option data-report-type="network" value="네트워크 트래픽이 가장 많은 서버는?">네트워크 트래픽 TOP 서버</option>
                    <option data-report-type="critical_error" value="Critical 상태인 DB 서버 목록">Critical 상태 DB 서버</option>
                    <option data-report-type="error_status" value="Seoul-IDC 위치의 서버 중 Error 상태인 서버는?">Seoul-IDC Error 서버</option>
                    <option data-report-type="application_error" value="애플리케이션 오류가 발생한 서버 찾아줘">애플리케이션 오류 발생 서버</option>
                    <option data-report-type="security" value="보안 경고가 있었던 서버는?">보안 경고 발생 서버</option>
                    <option data-report-type="generic_problem" value="어제부터 문제 있는 서버들 요약해줘">어제부터 문제 서버 요약</option>
                </select>
                <button id="nlp-submit-btn">질의 실행</button>
            </div>
            <div class="nlp-result-explanation" id="nlp-explanation">
                <strong>해석된 조건:</strong> (여기에 자연어 질의 해석 결과가 표시됩니다)
            </div>
        </section>

        <section class="nlp-summary-section">
            <h3>자연어 질의 결과 요약</h3>
            <div id="nlp-summary-list">
                </div>
            <div id="nlp-report-button-container" style="margin-top: 15px; text-align: right;">
                </div>
        </section>

        <hr style="margin: 30px 0;">

        <h2>기존 필터 기반 분석 (참고용)</h2>
        <div class="filters-section">
            <div class="filter-group">
                <label for="time-filter">시간 범위:</label>
                <select class="filter-select" id="time-filter">
                    <option value="1">최근 1시간</option> <option value="6">최근 6시간</option>
                    <option value="24" selected>최근 24시간</option> <option value="72">최근 3일</option>
                    <option value="168">최근 7일</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="server-type-filter">서버 유형:</label>
                <select class="filter-select" id="server-type-filter">
                    <option value="all">모든 서버 유형</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="location-filter">위치:</label>
                <select class="filter-select" id="location-filter">
                    <option value="all">모든 위치</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="alert-filter">문제 분석용 경고 필터:</label>
                <select class="filter-select" id="alert-filter">
                    <option value="all">모든 경고 (문제분석용)</option>
                    <option value="Critical">심각(Critical)만</option>
                    <option value="Error">오류(Error)만</option>
                    <option value="Warning">주의(Warning)만</option>
                </select>
            </div>
            <button class="filter-btn" id="apply-filter-btn">필터 적용 (참고용)</button>
        </div>

        <h2>리소스 사용률 TOP 5 (참고용)</h2>
        <div class="resource-sections-grid">
            <div class="resource-section" id="cpu-top-section"><h3>CPU 사용률 TOP 5</h3><div id="cpu-top-list"></div></div>
            <div class="resource-section" id="memory-top-section"><h3>메모리 사용률 TOP 5</h3><div id="memory-top-list"></div></div>
            <div class="resource-section" id="disk-top-section"><h3>디스크 사용률 TOP 5</h3><div id="disk-top-list"></div></div>
            <div class="resource-section" id="network-top-section"><h3>네트워크 트래픽 TOP 5</h3><div id="network-top-list"></div></div>
        </div>

        <div class="problem-section">
            <h3>주요 문제 발생 서버 TOP 5 (필터 기반 분석 결과)</h3>
            <div id="problematic-servers-list"></div>
        </div>

        <button class="csv-btn" id="download-csv-btn">종합 요약 CSV 다운로드</button>

    </div>

    <script src="fixed_dummy_data.js"></script>
    <script src="data_processor.js"></script>
    
    <script>
        // =================================================================================
        // 전역 변수 및 상태 관리
        // =================================================================================
        let allServerData = []; // 로드된 전체 서버 데이터
        let dataProcessor = null; // 데이터 처리 유틸리티 인스턴스
        
        // UI 요소 참조
        const loadingOverlay = document.getElementById('loading-overlay');
        const reportModal = document.getElementById('report-modal');
        const reportTitleEl = document.getElementById('report-title');
        const reportTextContentEl = document.getElementById('report-text-content');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        // =================================================================================
        // UI 유틸리티 함수
        // =================================================================================
        /** 로딩 오버레이를 표시합니다. */
        function showLoading() { if (loadingOverlay) loadingOverlay.style.display = 'flex'; }
        /** 로딩 오버레이를 숨깁니다. */
        function hideLoading() { if (loadingOverlay) loadingOverlay.style.display = 'none'; }

        /**
         * Select 엘리먼트에 옵션들을 동적으로 채웁니다.
         * @param {HTMLSelectElement} selectElement - 옵션을 채울 select DOM 요소
         * @param {string[]} optionsArray - 옵션 값(및 텍스트)으로 사용될 문자열 배열
         * @param {string} defaultOptionText - '모든 OOO'과 같은 기본 옵션의 텍스트
         */
        function populateDropdown(selectElement, optionsArray, defaultOptionText) {
            if (!selectElement) { 
                console.error("populateDropdown: Target select element not found for: " + defaultOptionText); 
                return; 
            }
            selectElement.innerHTML = `<option value="all">${defaultOptionText}</option>`; // 기본 '전체' 옵션
            (optionsArray || []).forEach(optionValue => {
                const option = document.createElement('option');
                option.value = optionValue; 
                option.textContent = optionValue;
                selectElement.appendChild(option);
            });
        }

        // =================================================================================
        // 데이터 렌더링 함수 (화면에 데이터를 표시하는 역할)
        // =================================================================================

        /**
         * 특정 리소스(CPU, 메모리 등)의 사용률 TOP N 서버 목록을 화면에 렌더링합니다.
         * @param {string} listElementId - 서버 목록을 표시할 div 요소의 ID
         * @param {object[]} servers - 표시할 서버 정보 객체 배열 (DataProcessor.getTopNServersByResource 결과)
         */
        function renderTopResourceList(listElementId, servers) {
            const listElement = document.getElementById(listElementId);
            if (!listElement) { console.error(`renderTopResourceList: Element with ID '${listElementId}' not found.`); return; }
            listElement.innerHTML = ''; // 이전 내용 초기화
            if (!servers || servers.length === 0) {
                listElement.innerHTML = '<p style="font-size:0.85em; color:#777; text-align:center; padding-top:20px;">해당 조건의 데이터 없음</p>';
                return;
            }
            servers.forEach(server => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'server-list-item';
                itemDiv.innerHTML = `
                    <span class="server-name" title="타입: ${server.type || 'N/A'} | 위치: ${server.location || 'N/A'}">${(server.name || 'N/A').split('.')[0]}</span>
                    <span class="server-usage">${(server.avgUsage !== undefined ? server.avgUsage.toFixed(1) : 'N/A')}${server.unit || ''}</span>
                `;
                listElement.appendChild(itemDiv);
            });
        }

        /**
         * 필터 기반으로 분석된 주요 문제 발생 서버 목록을 화면에 렌더링합니다.
         * @param {object[]} servers - 표시할 문제 서버 정보 객체 배열 (DataProcessor.getProblematicServersSummary 결과)
         */
        function renderProblematicServersList(servers) {
            const listElement = document.getElementById('problematic-servers-list');
            if (!listElement) { console.error("renderProblematicServersList: Element with ID 'problematic-servers-list' not found."); return; }
            listElement.innerHTML = '';
            if (!servers || servers.length === 0) {
                listElement.innerHTML = '<p style="font-size:0.85em; color:#777; text-align:center; padding-top:20px;">주요 문제 발생 서버 없음</p>';
                return;
            }
            servers.forEach(server => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'server-list-item problem-item'; // 스타일링을 위한 클래스
                itemDiv.innerHTML = `
                    <div>
                        <span class="server-name" title="타입: ${server.type || 'N/A'} | 위치: ${server.location || 'N/A'}">${(server.name || 'N/A').split('.')[0]}</span>
                        <div class="server-alerts" title="${server.recentProblemMessages || ''}">${server.recentProblemMessages || '상세 정보 확인 필요'}</div>
                    </div>
                    <span class="problem-score">Score: ${server.score || 0} (C:${server.criticalAlertCount || 0}/E:${server.errorAlertCount || 0}/W:${server.warningAlertCount || 0})</span>
                `;
                // 클릭 시 간단한 정보 알림 (추후 상세 보기 모달 등으로 확장 가능)
                itemDiv.addEventListener('click', () => {
                    alert(`서버: ${server.name || 'N/A'}\n타입: ${server.type || 'N/A'}\n위치: ${server.location || 'N/A'}\n문제 점수: ${server.score || 0}\n최근 문제 요약: ${server.recentProblemMessages || '없음'}`);
                });
                listElement.appendChild(itemDiv);
            });
        }

        /**
         * 자연어 질의 결과를 화면에 렌더링합니다.
         * @param {object[]} servers - NLP 질의로 요약된 서버 정보 객체 배열
         * @param {string} query - 사용자가 입력한 원본 질의
         * @param {string} detectedReportType - 해석된 보고서 유형 (버튼 생성에 사용)
         */
        function renderNLPSummaryList(servers, query, detectedReportType) {
            const resultListEl = document.getElementById('nlp-summary-list');
            const reportButtonContainer = document.getElementById('nlp-report-button-container');
            if (!resultListEl || !reportButtonContainer) { console.error("NLP result/button container not found."); return;}

            resultListEl.innerHTML = '';
            reportButtonContainer.innerHTML = ''; 

            if (!servers || servers.length === 0) {
                resultListEl.innerHTML = `<p style="font-size:0.85em; color:#777;">"${query}"에 대한 요약 결과가 없습니다.</p>`;
            } else {
                servers.forEach(server => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'server-list-item nlp-summary-item';
                    itemDiv.innerHTML = `
                        <div>
                            <span class="server-name" title="타입: ${server.type || 'N/A'} | 위치: ${server.location || 'N/A'}">${(server.name || 'N/A').split('.')[0]}</span>
                            <div class="server-details" title="${server.recentProblemMessages || ''}">${server.recentProblemMessages || '문제 상세 정보 없음'}</div>
                        </div>
                        <span class="nlp-relevance-score">분석점수: ${server.score || 0}</span>
                    `;
                    itemDiv.addEventListener('click', () => alert(`서버: ${server.name}\n문제 점수: ${server.score}\n상세: ${server.recentProblemMessages}`));
                    resultListEl.appendChild(itemDiv);
                });

                // 질의 결과가 있을 때만 보고서 생성 버튼 추가
                const reportButton = document.createElement('button');
                reportButton.className = 'report-button';
                reportButton.textContent = `${detectedReportType.replace(/_/g, ' ').toUpperCase()} 분석 보고서 생성`;
                reportButton.onclick = function() {
                    const report = generatePredefinedReport(detectedReportType, query, servers); // NLP 요약 결과를 보고서 생성에 전달
                    showReportModal(report.title, report.content);
                };
                reportButtonContainer.appendChild(reportButton);
            }
        }


        // =================================================================================
        // 보고서 생성 및 모달 관련 함수
        // =================================================================================
        /**
         * 미리 정의된 분석 보고서 내용을 생성합니다.
         * @param {string} reportType - 보고서 유형 ('cpu', 'memory', 'disk', 'network', 'critical_error' 등)
         * @param {string} query - 사용자가 입력한 원본 질의 (보고서 내용에 참고용으로 포함)
         * @param {object[]} filteredNlpData - NLP 질의로 필터링 및 요약된 데이터 (보고서 내용에 참고용으로 포함)
         * @returns {object} { title: string, content: string } 형태의 보고서 객체
         */
        function generatePredefinedReport(reportType, query, filteredNlpData) {
            let reportTitle = "분석 보고서";
            let reportContent = `원본 질의: "${query}"\n========================================\n\n`;
            const topProblemServer = filteredNlpData && filteredNlpData.length > 0 ? filteredNlpData[0] : null;
            // 전체 데이터에 대한 리소스 TOP N (필터 미적용된 전체 데이터 기준, 필요시 filteredNlpData 기반으로 변경 가능)
            const topServersForResource = (resourceKey, count = 3) => dataProcessor ? dataProcessor.getTopNServersByResource(allServerData, resourceKey, count) : [];

            switch(reportType.toLowerCase()) { // reportType을 소문자로 비교
                case 'cpu':
                    reportTitle = "CPU 사용률 상세 분석 보고서";
                    reportContent += "최근 CPU 사용률이 높은 서버들에 대한 심층 분석입니다.\n";
                    if (topProblemServer && topProblemServer.name) {
                        reportContent += `\n[질의 관련 주요 서버 분석]\n- 서버: ${topProblemServer.name} (유형: ${topProblemServer.type}, 위치: ${topProblemServer.location})\n- 분석 점수: ${topProblemServer.score}\n- 주요 경고: ${topProblemServer.recentProblemMessages}\n`;
                    }
                    reportContent += "\n[전체 기간 CPU 사용률 TOP3 서버 (평균)]\n";
                    topServersForResource('cpu').forEach((s,idx) => reportContent += `${idx+1}. ${s.name}: ${s.avgUsage}%\n`);
                    reportContent += "\n[조치 권고 사항]\n1. 해당 서버들의 시간별/일별 CPU 사용량 변화 추이를 면밀히 분석합니다.\n2. 'top', 'htop' 또는 APM 도구를 사용하여 CPU 점유율이 높은 특정 프로세스를 식별합니다.\n3. 불필요하거나 과도한 리소스를 사용하는 프로세스를 최적화하거나 재시작합니다.\n4. 지속적인 고부하 발생 시, 애플리케이션 코드 최적화 또는 서버 스펙 업그레이드(Scale-up)를 고려합니다.";
                    break;
                case 'memory':
                    reportTitle = "메모리 사용 현황 분석 보고서";
                    reportContent += "메모리 관련 문제 발생 서버 및 사용률 높은 서버 분석입니다.\n";
                     if (topProblemServer && topProblemServer.name) {
                        reportContent += `\n[질의 관련 주요 서버 분석]\n- 서버: ${topProblemServer.name} (유형: ${topProblemServer.type}, 위치: ${topProblemServer.location})\n- 분석 점수: ${topProblemServer.score}\n- 주요 경고: ${topProblemServer.recentProblemMessages}\n`;
                    }
                    reportContent += "\n[전체 기간 메모리 사용률 TOP3 서버 (평균)]\n";
                    topServersForResource('memory').forEach((s,idx) => reportContent += `${idx+1}. ${s.name}: ${s.avgUsage}%\n`);
                    reportContent += "\n[조치 권고 사항]\n1. 'free', 'vmstat' 또는 APM 도구를 사용하여 메모리 누수(Leak) 가능성을 정밀 점검합니다.\n2. Java 기반 애플리케이션의 경우, JVM Heap Dump를 생성하여 분석하고 GC 로그를 확인합니다.\n3. 불필요한 캐시 데이터 정리 및 애플리케이션의 메모리 사용 패턴을 최적화합니다.\n4. 필요시 메모리 증설 또는 서비스 분산을 통한 부하 경감을 고려합니다.";
                    break;
                case 'disk':
                    reportTitle = "디스크 사용 현황 분석 보고서";
                    reportContent += "디스크 공간 부족 또는 I/O 문제 관련 서버 분석입니다.\n";
                    if (topProblemServer && topProblemServer.name) {
                        reportContent += `\n[질의 관련 주요 서버 분석]\n- 서버: ${topProblemServer.name} (유형: ${topProblemServer.type}, 위치: ${topProblemServer.location})\n- 분석 점수: ${topProblemServer.score}\n- 주요 경고: ${topProblemServer.recentProblemMessages}\n`;
                    }
                    reportContent += "\n[전체 기간 디스크 사용률 TOP3 서버 (평균)]\n";
                    topServersForResource('disk').forEach((s,idx) => reportContent += `${idx+1}. ${s.name}: ${s.avgUsage}%\n`);
                    reportContent += "\n[조치 권고 사항]\n1. 'df -h', 'du -sh *' 명령어로 디스크 사용 현황을 파악하고, 불필요한 파일(오래된 로그, 임시파일, 백업 파일 등)을 주기적으로 정리합니다.\n2. 로그 로테이션(Log Rotation) 설정을 확인하고 최적화합니다.\n3. I/O 병목 현상 발생 시, 'iostat', 'iotop' 등으로 원인을 분석하고 디스크 성능 개선(예: RAID 구성 변경, 고성능 SSD로 교체)을 검토합니다.\n4. 지속적인 공간 부족 시 디스크 용량 증설 계획을 수립합니다.";
                    break;
                case 'network':
                    reportTitle = "네트워크 트래픽 및 문제 분석 보고서";
                    reportContent += "네트워크 트래픽 과다 또는 관련 문제 발생 서버 분석입니다.\n";
                    if (topProblemServer && topProblemServer.name) {
                        reportContent += `\n[질의 관련 주요 서버 분석]\n- 서버: ${topProblemServer.name} (유형: ${topProblemServer.type}, 위치: ${topProblemServer.location})\n- 분석 점수: ${topProblemServer.score}\n- 주요 경고: ${topProblemServer.recentProblemMessages}\n`;
                    }
                    reportContent += "\n[전체 기간 네트워크 트래픽(In/Out 합산) TOP3 서버 (평균)]\n";
                    topServersForResource('network').forEach((s,idx) => reportContent += `${idx+1}. ${s.name}: ${s.avgUsage} Mbps\n`);
                    reportContent += "\n[조치 권고 사항]\n1. 'netstat', 'iftop', 'nload' 등으로 실시간 트래픽을 모니터링하여 비정상적인 트래픽 발생 원인(DDoS 공격, 악성코드 감염, 잘못된 설정 등)을 분석합니다.\n2. 대용량 파일 전송, 스트리밍 서비스 등 트래픽 유발 요인을 파악하고 최적화합니다.\n3. 필요시 네트워크 대역폭 증설 또는 CDN 도입, 로드밸런싱을 통한 트래픽 분산을 고려합니다.\n4. 네트워크 장비(스위치, 라우터, 방화벽)의 상태 및 설정을 점검합니다.";
                    break;
                case 'application_error':
                    reportTitle = "애플리케이션 오류 분석 보고서";
                    reportContent += "애플리케이션 레벨에서 오류가 발생한 서버에 대한 분석입니다.\n";
                    if (filteredNlpData && filteredNlpData.length > 0) {
                        reportContent += "\n[질의 관련 오류 발생 서버 목록 (최대 5개)]\n";
                        filteredNlpData.filter(s => s.alerts && s.alerts.some(al => al.type === 'Application')) 
                            .slice(0,5)
                            .forEach(s => {
                                const appAlerts = s.alerts.filter(al => al.type === 'Application').map(al => `[${al.severity}] ${al.message}`).join('; ');
                                reportContent += `- ${s.name} (타입: ${s.type}, 위치: ${s.location})\n   오류 내용: ${appAlerts}\n`;
                            });
                    } else {
                        reportContent += "\n현재 조건에서 애플리케이션 오류가 발생한 서버를 찾지 못했습니다.\n";
                    }
                    reportContent += "\n[조치 권고 사항]\n1. 해당 서버의 애플리케이션 로그(예: Tomcat catalina.out, Spring Boot 로그)를 상세 분석합니다.\n2. 스택 트레이스(Stack Trace)를 확인하여 오류 발생 지점의 코드 및 원인을 특정합니다.\n3. 개발 환경에서 오류 재현 테스트를 수행하고 버그 수정 후 패치를 배포합니다.\n4. APM(Application Performance Management) 도구를 활용하여 실시간 오류 모니터링 및 분석을 강화합니다.";
                    break;
                 case 'security':
                    reportTitle = "보안 경고 분석 보고서";
                    reportContent += "보안 관련 경고가 발생한 서버에 대한 분석입니다.\n";
                     if (filteredNlpData && filteredNlpData.length > 0) {
                        reportContent += "\n[질의 관련 보안 경고 발생 서버 목록 (최대 5개)]\n";
                        filteredNlpData.filter(s => s.alerts && s.alerts.some(al => al.type === 'Security'))
                            .slice(0,5)
                            .forEach(s => {
                                const secAlerts = s.alerts.filter(al => al.type === 'Security').map(al => `[${al.severity}] ${al.message}`).join('; ');
                                reportContent += `- ${s.name} (타입: ${s.type}, 위치: ${s.location})\n   경고 내용: ${secAlerts}\n`;
                            });
                    } else {
                        reportContent += "\n현재 조건에서 보안 경고가 발생한 서버를 찾지 못했습니다.\n";
                    }
                    reportContent += "\n[조치 권고 사항]\n1. 발생한 보안 경고의 심각도와 내용을 바탕으로 즉시 침해 사고 분석 및 영향 범위를 확인합니다.\n2. 의심스러운 로그인 시도, 악성코드 감염 등의 경우 관련 계정 암호 변경, 접근 통제 강화, 시스템 격리 등의 조치를 취합니다.\n3. 최신 보안 패치 적용 및 시스템 보안 설정을 강화하고, 방화벽 및 IDS/IPS 정책을 검토하여 업데이트합니다.\n4. 정기적인 보안 취약점 점검 및 모의 해킹 테스트를 수행합니다.";
                    break;
                case 'critical_error': 
                case 'error_status':
                    reportTitle = "주요 오류 및 장애 심층 분석 보고서";
                     if (topProblemServer && topProblemServer.name) {
                        reportContent += `\n[질의 관련 주요 문제 서버 분석]\n- 서버: ${topProblemServer.name} (유형: ${topProblemServer.type}, 위치: ${topProblemServer.location})\n- 분석 점수: ${topProblemServer.score}\n- 주요 경고 요약: ${topProblemServer.recentProblemMessages}\n\n`;
                        const criticalEvents = (allServerData || []).filter(d => d.serverHostname === topProblemServer.name && (d.status === 'Critical' || d.status === 'Error'))
                                                .sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp))
                                                .slice(0,5); // 최근 5개 이벤트
                        if(criticalEvents.length > 0) {
                            reportContent += `[최근 주요 Critical/Error 이벤트 상세]\n`;
                            criticalEvents.forEach(evt => {
                                reportContent += `- ${new Date(evt.timestamp).toLocaleString('ko-KR')}: 상태 '${evt.status}'. 발생 경고: ${evt.alerts.map(a => `[${a.severity}-${a.type}] ${a.message}`).join('; ')}\n`;
                            });
                        } else {
                            reportContent += "해당 서버의 최근 Critical/Error 상태 이력을 찾을 수 없었습니다 (필터링된 기간 내).\n";
                        }
                    } else {
                        reportContent += "\n해당 조건에 맞는 주요 문제 서버를 찾지 못했습니다.\n";
                    }
                    reportContent += "\n[조치 권고 사항]\n1. 즉시 해당 서버에 접속하여 시스템 로그(예: /var/log/messages, dmesg) 및 애플리케이션 상세 로그를 확인합니다.\n2. 관련 서비스의 현재 상태 및 비즈니스 영향도를 신속히 파악하고, 필요시 긴급 복구 절차(예: 서비스 재시작, 페일오버)를 진행합니다.\n3. 문제 발생 시점 전후의 변경 사항(배포, 설정 변경 등)을 확인하고, 근본 원인 분석 및 재발 방지 대책을 수립하여 문서화합니다.";
                    break;
                default: // generic_problem 또는 기타
                    reportTitle = "종합 문제 분석 보고서";
                    reportContent += `"${query}" 관련 종합 분석입니다.\n`;
                    if (filteredNlpData && filteredNlpData.length > 0) {
                        reportContent += "\n[주요 특이사항 관찰 서버 (상위 3개)]\n";
                        filteredNlpData.slice(0,3).forEach(s => {
                            reportContent += `- ${s.name} (타입: ${s.type}, 위치: ${s.location}, 분석점수: ${s.score})\n   주요 특이사항: ${s.recentProblemMessages}\n`;
                        });
                    } else {
                        reportContent += "\n특별한 문제점이 감지되지 않았습니다.\n";
                    }
                    reportContent += "\n[일반 권고 사항]\n- 전체 시스템에 대한 지속적인 모니터링 체계를 유지하고, 주요 지표에 대한 임계치 관리를 철저히 합니다.\n- 정기적인 시스템 점검 및 예방적 유지보수 활동을 수행합니다.\n- 장애 발생 시 신속한 대응을 위한 비상 연락망 및 장애 대응 절차를 최신 상태로 유지합니다.";
            }
            return { title: reportTitle, content: reportContent };
        }

        /** 모달 창에 보고서 제목과 내용을 표시합니다. */
        function showReportModal(title, content) {
            if (reportModal && reportTitleEl && reportTextContentEl) {
                reportTitleEl.textContent = title;
                reportTextContentEl.textContent = content; // <pre> 태그는 자동으로 줄바꿈과 공백을 유지
                reportModal.style.display = "block";
            } else {
                console.error("Report modal elements not found.");
            }
        }

        // =================================================================================
        // 자연어 질의 처리 로직
        // =================================================================================
        /**
         * 사용자의 자연어 질의를 해석하고, 그에 따른 서버 데이터를 분석하여 결과를 표시합니다.
         * @param {string} query - 사용자가 입력한 자연어 질의 문자열
         */
        function interpretAndExecuteNLPQuery(query) {
            showLoading();
            const explanationEl = document.getElementById('nlp-explanation');
            const resultListEl = document.getElementById('nlp-summary-list');
            const reportButtonContainer = document.getElementById('nlp-report-button-container');

            if (!explanationEl || !resultListEl || !reportButtonContainer) {
                console.error("NLP UI elements not found.");
                hideLoading();
                return;
            }

            resultListEl.innerHTML = '';
            reportButtonContainer.innerHTML = ''; 

            // --- 매우 단순화된 규칙 기반 자연어 해석 ---
            let timeRange = 24; // 기본값: 최근 24시간
            let serverType = 'all';
            let alertFilter = 'all'; // DataProcessor.applyFilters에서 처리할 값
            let location = 'all';
            let interpretation = ""; // 해석된 조건 설명
            let detectedReportType = 'generic_problem'; // 기본 보고서 유형

            const lowerQuery = query.toLowerCase();

            // 예시 질문 선택 드롭다운에서 data-report-type 값 우선 사용
            const selectedOption = document.querySelector(`#nlp-query-select option[value="${query}"]`);
            if (selectedOption && selectedOption.dataset.reportType) {
                detectedReportType = selectedOption.dataset.reportType;
            }

            // 1. 시간 범위 키워드 추출
            if (lowerQuery.includes("최근 1시간")) { timeRange = 1; interpretation += "시간: 최근 1시간, "; }
            else if (lowerQuery.includes("최근 6시간")) { timeRange = 6; interpretation += "시간: 최근 6시간, "; }
            else if (lowerQuery.includes("최근 3일")) { timeRange = 72; interpretation += "시간: 최근 3일, "; }
            else if (lowerQuery.includes("최근 7일") || lowerQuery.includes("일주일")) { timeRange = 168; interpretation += "시간: 최근 7일, "; }
            else if (lowerQuery.includes("어제")) { /* 어제에 대한 시간 범위 설정 (복잡도 증가) - 일단 24시간 유지 */ interpretation += "시간: 어제(구체적 시간 미지정), ";}


            // 2. 서버 타입 키워드 추출
            const uniqueServerTypes = dataProcessor ? dataProcessor.getUniqueServerTypes() : [];
            for (const type of uniqueServerTypes) {
                if (lowerQuery.includes(type.toLowerCase())) {
                    serverType = type;
                    interpretation += `서버타입: ${type}, `;
                    break;
                }
            }
            
            // 3. 위치 키워드 추출
            const uniqueLocations = dataProcessor ? dataProcessor.getUniqueLocations() : [];
            for (const loc of uniqueLocations) {
                if (query.includes(loc)) { // 위치명은 대소문자 구분 가능성 있으므로 원본 query 사용
                    location = loc;
                    interpretation += `위치: ${loc}, `;
                    break;
                }
            }

            // 4. 경고/상태 관련 키워드 및 보고서 타입 결정 (우선순위 고려)
            if (detectedReportType !== 'generic_problem') { // 예시 질문에서 reportType이 지정된 경우
                if (detectedReportType.toLowerCase().includes('cpu')) alertFilter = 'CPU';
                else if (detectedReportType.toLowerCase().includes('memory')) alertFilter = 'Memory';
                else if (detectedReportType.toLowerCase().includes('disk')) alertFilter = 'Disk';
                else if (detectedReportType.toLowerCase().includes('network')) alertFilter = 'Network';
                else if (detectedReportType.toLowerCase().includes('critical')) alertFilter = 'Critical';
                else if (detectedReportType.toLowerCase().includes('error')) alertFilter = 'Error';
                else if (detectedReportType.toLowerCase().includes('application')) alertFilter = 'Application';
                else if (detectedReportType.toLowerCase().includes('security')) alertFilter = 'Security';
                interpretation += `주요 분석 대상: ${detectedReportType.replace(/_/g, ' ').toUpperCase()}, `;
            } else { // 직접 입력 또는 일반적인 문제 요약 시
                if (lowerQuery.includes("cpu")) { alertFilter = 'CPU'; interpretation += "경고타입: CPU, "; detectedReportType = 'cpu'; }
                else if (lowerQuery.includes("메모리") || lowerQuery.includes("memory")) { alertFilter = 'Memory'; interpretation += "경고타입: Memory, "; detectedReportType = 'memory'; }
                else if (lowerQuery.includes("디스크") || lowerQuery.includes("disk")) { alertFilter = 'Disk'; interpretation += "경고타입: Disk, "; detectedReportType = 'disk'; }
                else if (lowerQuery.includes("네트워크") || lowerQuery.includes("network")) { alertFilter = 'Network'; interpretation += "경고타입: Network, "; detectedReportType = 'network'; }
                else if (lowerQuery.includes("critical") || lowerQuery.includes("심각")) { alertFilter = 'Critical'; interpretation += "심각도: Critical, "; detectedReportType = 'critical_error';}
                else if (lowerQuery.includes("error") || lowerQuery.includes("오류")) { alertFilter = 'Error'; interpretation += "심각도: Error, "; detectedReportType = 'error_status';}
                else if (lowerQuery.includes("warning") || lowerQuery.includes("주의")) { alertFilter = 'Warning'; interpretation += "심각도: Warning, "; /* Warning은 generic_problem 유지 가능 */ }
                else if (lowerQuery.includes("애플리케이션") || lowerQuery.includes("application")) { alertFilter = 'Application'; interpretation += "경고타입: Application, "; detectedReportType = 'application_error';}
                else if (lowerQuery.includes("보안") || lowerQuery.includes("security")) { alertFilter = 'Security'; interpretation += "경고타입: Security, "; detectedReportType = 'security';}
            }
            // --- 해석 로직 끝 ---
            
            explanationEl.innerHTML = `<strong>해석된 조건:</strong> ${interpretation || "일반 요약 (모든 조건 적용)"}`;

            // 해석된 조건으로 데이터 필터링 및 요약 (비동기 효과를 위한 setTimeout)
            setTimeout(() => {
                try {
                    if (!dataProcessor) { throw new Error("DataProcessor가 초기화되지 않았습니다."); }
                    const filteredNlpData = dataProcessor.applyFilters(timeRange, serverType, alertFilter, location);
                    // 자연어 질의 결과는 주로 문제 상황 요약에 초점
                    const nlpSummary = dataProcessor.getProblematicServersSummary(filteredNlpData, 5); // 상위 5개 문제 서버

                    renderNLPSummaryList(nlpSummary, query, detectedReportType); // NLP 결과 및 보고서 버튼 렌더링
                    
                    // LLM 활용 방안 안내 (고정 텍스트)
                    const llmGuidance = `현재 데모는 입력된 질의를 바탕으로 사전 정의된 규칙에 따라 필터링합니다. 실제 LLM(대규모 언어 모델)을 연동하면, "어제 오후부터 오늘 새벽 사이에 Seoul-IDC의 DB서버 중 디스크 사용률이 80%를 넘고 CPU 부하도 높았던 서버들의 로그 요약해줘" 와 같이 복잡하고 미묘한 자연어 질문도 이해하여, 다중 조건(시간 범위, 위치, 서버타입, 지표 임계치, 경고 패턴 등)으로 변환하고, 그 결과를 바탕으로 심층 분석 및 요약 보고서를 동적으로 생성할 수 있습니다. 또한, 과거 이력 및 유사 장애 패턴을 학습하여 잠재적인 문제 예측 및 선제적 대응 방안 제시도 가능해집니다.`;
                    explanationEl.innerHTML += `<br><br><details><summary><strong>LLM 활용 상세 방안 (클릭)</strong></summary><p style="font-size:0.9em; padding-left:15px;">${llmGuidance}</p></details>`;

                } catch (e) {
                    console.error("NLP 질의 처리 중 오류:", e);
                    if(resultListEl) resultListEl.innerHTML = `<p style="color:red;">질의 처리 중 오류가 발생했습니다: ${e.message}</p>`;
                } finally {
                    hideLoading();
                }
            }, 500); 
        }

        // =================================================================================
        // 기존 필터 기반 분석 함수 (참고용)
        // =================================================================================
        function applyAndRenderLegacyFilters() {
            showLoading();
            setTimeout(() => {
                try {
                    if (!dataProcessor) { hideLoading(); return; }
                    const timeRange = document.getElementById('time-filter').value;
                    const serverType = document.getElementById('server-type-filter').value;
                    const alertForProblemAnalysis = document.getElementById('alert-filter').value; // 이 필터는 '문제 서버 분석'에만 사용
                    const location = document.getElementById('location-filter').value;

                    // 리소스 Top N은 시간, 서버타입, 위치 필터만 적용 (경고 종류 필터는 미적용)
                    const baseFilteredData = dataProcessor.applyFilters(parseInt(timeRange), serverType, 'all', location);
                    renderTopResourceList('cpu-top-list', dataProcessor.getTopNServersByResource(baseFilteredData, 'cpu'));
                    renderTopResourceList('memory-top-list', dataProcessor.getTopNServersByResource(baseFilteredData, 'memory'));
                    renderTopResourceList('disk-top-list', dataProcessor.getTopNServersByResource(baseFilteredData, 'disk'));
                    renderTopResourceList('network-top-list', dataProcessor.getTopNServersByResource(baseFilteredData, 'network'));
                    
                    // '문제 발생 서버 TOP 5'는 alertForProblemAnalysis 필터까지 적용
                    const problemFilteredData = dataProcessor.applyFilters(parseInt(timeRange), serverType, alertForProblemAnalysis, location);
                    renderProblematicServersList(dataProcessor.getProblematicServersSummary(problemFilteredData));

                    updateTimestamp();
                } catch (error) {
                    console.error('기존 필터 적용 및 렌더링 오류:', error);
                } finally {
                    hideLoading();
                }
            }, 50);
        }
        
        // =================================================================================
        // 공통 유틸리티 및 이벤트 리스너 설정
        // =================================================================================
        /** 데이터 기준 시각을 화면에 업데이트합니다. */
        function updateTimestamp() {
            const timestampEl = document.getElementById('timestamp');
            if (timestampEl) {
                const dataEndTime = allServerData && allServerData.length > 0 ? new Date(Math.max(...allServerData.map(d => new Date(d.timestamp).getTime()))) : new Date();
                timestampEl.textContent = `데이터 기준 시각: ${dataEndTime.toLocaleString('ko-KR', { year: 'numeric', month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: false })}`;
            }
        }

        /** 페이지 내 주요 UI 요소들에 대한 이벤트 리스너를 설정합니다. */
        function setupEventListeners() {
             // NLP 섹션
             const nlpInput = document.getElementById('nlp-query-input');
             const nlpSelect = document.getElementById('nlp-query-select');
             const nlpSubmitBtn = document.getElementById('nlp-submit-btn');

             if(nlpSelect) {
                nlpSelect.addEventListener('change', function() {
                    if (this.value && nlpInput) { // nlpInput 존재 여부 확인
                        nlpInput.value = this.value;
                    }
                });
             }
             if(nlpSubmitBtn && nlpInput) { // nlpInput 존재 여부 확인
                nlpSubmitBtn.addEventListener('click', function() {
                    const query = nlpInput.value.trim();
                    if (query) interpretAndExecuteNLPQuery(query);
                    else alert("질의를 입력하거나 예시를 선택해주세요.");
                });
             }
             if(nlpInput) {
                 nlpInput.addEventListener('keypress', function(e) {
                     if (e.key === 'Enter') {
                         const query = nlpInput.value.trim();
                         if (query) interpretAndExecuteNLPQuery(query);
                         e.preventDefault(); 
                     }
                 });
             }

             // 기존 필터 섹션
             const legacyApplyBtn = document.getElementById('apply-filter-btn');
             if(legacyApplyBtn) legacyApplyBtn.addEventListener('click', applyAndRenderLegacyFilters);
             
             // CSV 다운로드
             const csvBtn = document.getElementById('download-csv-btn');
             if(csvBtn) csvBtn.addEventListener('click', downloadCombinedCSV);

             // 모달 닫기
             if(modalCloseBtn) {
                modalCloseBtn.onclick = function() {
                    if(reportModal) reportModal.style.display = "none";
                }
             }
             window.onclick = function(event) { // 모달 바깥 클릭 시 닫기
                if (event.target == reportModal) {
                    if(reportModal) reportModal.style.display = "none";
                }
             }
        }

        /** 현재 분석된 내용을 CSV 파일로 다운로드합니다. */
        function downloadCombinedCSV() { /* 이전과 동일 */
            showLoading();
            try {
                if (!dataProcessor) { alert("데이터 미로드"); hideLoading(); return; }
                const timeRange = document.getElementById('time-filter').value;
                const serverType = document.getElementById('server-type-filter').value;
                const locationVal = document.getElementById('location-filter').value;
                const alertForProblemAnalysis = document.getElementById('alert-filter').value;

                const baseFilteredData = dataProcessor.applyFilters(parseInt(timeRange), serverType, 'all', locationVal);
                const problemFilteredData = dataProcessor.applyFilters(parseInt(timeRange), serverType, alertForProblemAnalysis, locationVal);

                let csvContent = "항목,서버명,서버타입,위치,값/점수,단위/상세정보\n";
                
                const resources = [
                    {key: 'cpu', name: 'CPU 사용률 TOP5'}, {key: 'memory', name: '메모리 사용률 TOP5'},
                    {key: 'disk', name: '디스크 사용률 TOP5'}, {key: 'network', name: '네트워크 트래픽 TOP5'}
                ];
                resources.forEach(res => {
                    const topServers = dataProcessor.getTopNServersByResource(baseFilteredData, res.key);
                    (topServers || []).forEach(s => {
                        csvContent += `"${res.name}","${s.name || ''}","${s.type || ''}","${s.location || ''}",${s.avgUsage !== undefined ? s.avgUsage.toFixed(1) : ''},"${s.unit || ''}"\n`;
                    });
                });

                const problemServers = dataProcessor.getProblematicServersSummary(problemFilteredData);
                (problemServers || []).forEach(s => {
                    const details = `C:${s.criticalAlertCount || 0}/E:${s.errorAlertCount || 0}/W:${s.warningAlertCount || 0} | ${(s.recentProblemMessages || '').replace(/"/g, '""')}`;
                    csvContent += `"문제서버 TOP5","${s.name || ''}","${s.type || ''}","${s.location || ''}",${s.score || 0},"${details}"\n`;
                });

                const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", `OpenManager_분석요약_${new Date().toISOString().slice(0,10)}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

            } catch (error) {
                console.error('CSV 다운로드 오류:', error);
                alert('CSV 파일 생성 중 오류가 발생했습니다.');
            } finally {
                hideLoading();
            }
        }

        // =================================================================================
        // 페이지 초기화 로직
        // =================================================================================
        document.addEventListener('DOMContentLoaded', function() {
            showLoading(); // 페이지 로드 시작 시 로딩 표시
            try {
                // 필수 외부 스크립트 및 함수 존재 여부 확인
                if (typeof getFixedDummyData !== 'function' ) {
                    console.error("getFixedDummyData is not defined! fixed_dummy_data.js 파일 로드 또는 함수명을 확인하세요.");
                    alert("필수 데이터 생성 스크립트를 로드할 수 없습니다."); 
                    hideLoading(); return;
                }
                allServerData = getFixedDummyData();
                console.log(`고정 더미 데이터 ${allServerData.length}개 로드 완료.`);

                if (!allServerData || allServerData.length === 0) {
                     alert("로드된 서버 데이터가 없습니다. fixed_dummy_data.js를 확인하세요."); 
                     hideLoading(); return;
                }
                
                if (typeof ServerDataProcessor !== 'function') {
                    console.error("ServerDataProcessor is not defined! data_processor.js 파일 로드 또는 클래스명을 확인하세요."); 
                    alert("필수 데이터 처리 스크립트를 로드할 수 없습니다."); 
                    hideLoading(); return;
                }
                dataProcessor = new ServerDataProcessor(allServerData);
                console.log('DataProcessor 초기화 완료.');
                
                // 초기화 함수들 호출
                initializeLegacyFilters();      // 참고용 필터 UI 초기화
                applyAndRenderLegacyFilters();  // 참고용 데이터 초기 로드 및 렌더링
                setupEventListeners();          // 모든 이벤트 리스너 설정 (NLP 포함)

                // NLP 섹션에 대한 초기 질의 실행 (선택 사항, 예를 들어 기본 환영 메시지나 요약 표시)
                // interpretAndExecuteNLPQuery("오늘 발생한 주요 경고 요약해줘"); 

            } catch (error) {
                console.error('페이지 초기화 중 심각한 오류 발생:', error);
                alert('페이지를 초기화하는 중 심각한 오류가 발생했습니다. 개발자 콘솔을 확인해주세요.');
            } finally {
                hideLoading(); // 모든 초기화 과정이 끝나면 로딩 숨김 (오류 발생 시에도)
            }
        });
    </script>
</body>
</html>
