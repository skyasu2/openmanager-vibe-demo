<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenManager 7.0 - ì„œë²„ ìƒíƒœ ìš”ì•½ (ë°ëª¨)</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* demo.html íŠ¹ì • ìŠ¤íƒ€ì¼ ì¶”ê°€ ê°€ëŠ¥ */
        body { font-family: 'Malgun Gothic', 'Segoe UI', sans-serif; margin: 0; padding: 0; color: #333; background-color: #f5f7fa; }
        .header { background-color: #2c3e50; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 20px; font-weight: bold; }
        .nav-menu { display: flex; }
        .nav-item { padding: 8px 15px; margin-left: 5px; color: white; text-decoration: none; border-radius: 4px; }
        .nav-item.active { background-color: #3498db; }
        .container { max-width: 1200px; margin: 20px auto; padding: 20px; background-color: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #2c3e50; }
        h1 { text-align: center; margin-bottom: 5px;}
        h2 { border-bottom: 1px solid #eee; padding-bottom: 10px; margin-top: 30px; margin-bottom: 20px; font-size: 1.2em; }
        .timestamp { text-align: center; color: #7f8c8d; margin-bottom: 25px; font-size: 0.9em; }
        .filters-section { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 25px; padding: 15px; background-color: #f9f9f9; border-radius: 6px; align-items: center; }
        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { font-size: 0.85em; margin-bottom: 5px; color: #555; }
        .filter-select { padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; background-color: white; min-width: 150px; }
        .filter-btn { padding: 9px 18px; background-color: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.3s; }
        .filter-btn:hover { background-color: #2980b9; }
        .server-table { width: 100%; border-collapse: collapse; background-color: white; }
        .server-table th, .server-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        .server-table th { background-color: #f8f9fa; font-weight: 600; }
        .server-table tr:hover { background-color: #f5f5f5; }
        .alert-icon { margin-right: 5px; font-weight: bold; }
        .csv-btn { margin-top: 20px; display: inline-block; padding: 10px 20px; background-color: #2ecc71; color: white; text-decoration: none; border-radius: 4px; font-size: 0.9em; cursor: pointer; border: none; transition: background-color 0.3s; }
        .csv-btn:hover { background-color: #27ae60; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.85); display: none; justify-content: center; align-items: center; z-index: 10000; }
        .loading-spinner { border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <header class="header">
        <div class="logo">OpenManager 7.0</div>
        <nav class="nav-menu">
            <a href="index.html" class="nav-item">ì†Œê°œ</a>
            <a href="demo.html" class="nav-item active">ì„œë²„ ìš”ì•½ ëŒ€ì‹œë³´ë“œ</a>
            <a href="cpu-analysis.html" class="nav-item">CPU ë¶„ì„</a>
            </nav>
    </header>

    <div class="container">
        <h1>ì„œë²„ ìƒíƒœ ìš”ì•½</h1>
        <div class="timestamp" id="timestamp">ë°ì´í„° ê¸°ì¤€ ì‹œê°: ë¡œë”© ì¤‘...</div>

        <div class="filters-section">
            <div class="filter-group">
                <label for="time-filter">ì‹œê°„ ë²”ìœ„:</label>
                <select class="filter-select" id="time-filter">
                    <option value="1">ìµœê·¼ 1ì‹œê°„</option>
                    <option value="6">ìµœê·¼ 6ì‹œê°„</option>
                    <option value="24" selected>ìµœê·¼ 24ì‹œê°„</option>
                    <option value="72">ìµœê·¼ 3ì¼</option>
                    <option value="168">ìµœê·¼ 7ì¼</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="server-type-filter">ì„œë²„ ìœ í˜•:</label>
                <select class="filter-select" id="server-type-filter">
                    <option value="all">ëª¨ë“  ì„œë²„ ìœ í˜•</option>
                    </select>
            </div>
            <div class="filter-group">
                <label for="location-filter">ìœ„ì¹˜:</label>
                <select class="filter-select" id="location-filter">
                    <option value="all">ëª¨ë“  ìœ„ì¹˜</option>
                    </select>
            </div>
            <div class="filter-group">
                <label for="alert-filter">ê²½ê³  í•„í„°:</label>
                <select class="filter-select" id="alert-filter">
                    <option value="all">ëª¨ë“  ê²½ê³ </option>
                    <option value="Critical">ì‹¬ê°(Critical)ë§Œ</option>
                    <option value="Error">ì˜¤ë¥˜(Error)ë§Œ</option>
                    <option value="Warning">ì£¼ì˜(Warning)ë§Œ</option>
                    <option value="Info">ì •ë³´(Info)ë§Œ</option>
                    </select>
            </div>
            <button class="filter-btn" id="apply-filter-btn" style="align-self: flex-end;">í•„í„° ì ìš©</button>
        </div>

        <h2>ê²½ê³  ìƒìœ„ ì„œë²„ TOP (ê¸°ë³¸ 10ê°œ)</h2> <table class="server-table">
            <thead>
                <tr>
                    <th>ì„œë²„ í˜¸ìŠ¤íŠ¸ë„¤ì„</th>
                    <th>ì„œë²„ ìœ í˜•</th>
                    <th>ìœ„ì¹˜</th>
                    <th>ì£¼ìš” ê²½ê³  ìˆ˜ (C/E/W)</th>
                    <th>ì£¼ìš” ê²½ê³  ë‚´ìš©</th>
                    <th>ìµœê·¼ ìƒíƒœ</th>
                </tr>
            </thead>
            <tbody id="server-list-tbody">
                </tbody>
        </table>

        <button class="csv-btn" id="download-csv-btn">ê²°ê³¼ CSV ë‹¤ìš´ë¡œë“œ</button>
    </div>

    <script src="fixed_dummy_data.js"></script>
    <script src="data_processor.js"></script>
    <script>
        let allServerData = [];
        let dataProcessor = null;
        const loadingOverlay = document.getElementById('loading-overlay');

        function showLoading() {
            if (loadingOverlay) loadingOverlay.style.display = 'flex';
        }
        function hideLoading() {
            if (loadingOverlay) loadingOverlay.style.display = 'none';
        }

        function populateDropdown(selectElement, optionsArray, defaultOptionText) {
            if (!selectElement) {
                console.error(`Dropdown element for "${defaultOptionText}" not found.`);
                return;
            }
            selectElement.innerHTML = `<option value="all">${defaultOptionText}</option>`;
            optionsArray.forEach(optionValue => {
                const option = document.createElement('option');
                option.value = optionValue;
                option.textContent = optionValue;
                selectElement.appendChild(option);
            });
        }
        
        function initializeFilters() {
            const serverTypeFilterEl = document.getElementById('server-type-filter');
            const locationFilterEl = document.getElementById('location-filter');
            const alertFilterEl = document.getElementById('alert-filter');

            if(dataProcessor) {
                populateDropdown(serverTypeFilterEl, dataProcessor.getUniqueServerTypes(), 'ëª¨ë“  ì„œë²„ ìœ í˜•');
                populateDropdown(locationFilterEl, dataProcessor.getUniqueLocations(), 'ëª¨ë“  ìœ„ì¹˜');
                
                const uniqueAlertTypes = dataProcessor.getUniqueAlertTypes();
                if (alertFilterEl && uniqueAlertTypes) {
                    uniqueAlertTypes.forEach(alertType => {
                        if (!['Critical', 'Error', 'Warning', 'Info'].includes(alertType)) {
                            const option = document.createElement('option');
                            option.value = alertType;
                            option.textContent = `${alertType} ê´€ë ¨ ê²½ê³ `;
                            alertFilterEl.appendChild(option);
                        }
                    });
                }
            } else {
                console.error("DataProcessor is not initialized. Cannot populate filters.");
            }
        }

        function applyAndRenderFilters() {
            showLoading();
            setTimeout(() => {
                try {
                    if (!dataProcessor) {
                        console.error("DataProcessor is not available for filtering.");
                        alert("ë°ì´í„° ì²˜ë¦¬ ëª¨ë“ˆì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                        hideLoading();
                        return;
                    }
                    const timeRange = document.getElementById('time-filter').value;
                    const serverType = document.getElementById('server-type-filter').value;
                    const alertValue = document.getElementById('alert-filter').value;
                    const location = document.getElementById('location-filter').value;

                    const filteredData = dataProcessor.applyFilters(parseInt(timeRange), serverType, alertValue, location);
                    const topServersSummary = dataProcessor.getAlertSummaryByServer(filteredData);
                    
                    updateServerTable(topServersSummary.slice(0, 10));
                    updateTimestamp();
                } catch (error) {
                    console.error('í•„í„° ì ìš© ë° ë Œë”ë§ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                    alert('ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                } finally {
                    hideLoading();
                }
            }, 50);
        }

        function updateServerTable(serversSummary) {
            const tableBody = document.getElementById('server-list-tbody');
            if (!tableBody) {
                console.error("Table body 'server-list-tbody' not found.");
                return;
            }
            tableBody.innerHTML = '';

            if (!serversSummary || serversSummary.length === 0) {
                const row = tableBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 6;
                cell.textContent = 'ì¡°ê±´ì— ë§ëŠ” ì„œë²„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
                cell.style.textAlign = 'center';
                cell.style.padding = '20px';
                return;
            }

            serversSummary.forEach(summary => {
                const row = tableBody.insertRow();
                let icon = '';
                let statusColor = 'inherit'; // ê¸°ë³¸ê°’

                if (summary.highestSeverityCode === 4) { icon = 'ğŸ”´'; statusColor = 'crimson'; }
                else if (summary.highestSeverityCode === 3) { icon = 'ğŸŸ '; statusColor = 'darkorange'; }
                else if (summary.highestSeverityCode === 2) { icon = 'ğŸŸ¡'; statusColor = 'gold'; }
                else if (summary.highestSeverityCode === 1) { icon = 'ğŸ”µ'; statusColor = 'royalblue'; }
                else if (summary.lastStatus === 'Normal') { icon = 'ğŸŸ¢'; statusColor = 'green'; }


                row.insertCell().innerHTML = `<span class="alert-icon" title="${summary.lastStatus || 'N/A'}">${icon}</span> ${summary.name || 'N/A'}`;
                row.insertCell().textContent = summary.type || 'N/A';
                row.insertCell().textContent = summary.location || 'N/A';
                
                const alertCountsText = `C:${summary.criticalCount || 0}/E:${summary.errorCount || 0}/W:${summary.warningCount || 0}`;
                const countsCell = row.insertCell();
                countsCell.textContent = alertCountsText;
                if (summary.criticalCount > 0) countsCell.style.color = 'crimson';
                else if (summary.errorCount > 0) countsCell.style.color = 'darkorange';
                else if (summary.warningCount > 0) countsCell.style.color = 'gold'; // ì˜¤íƒ€ ìˆ˜ì • (gold)

                const issueCell = row.insertCell();
                issueCell.textContent = summary.mainIssueMessage || 'N/A';
                if(summary.distinctAlertMessages && summary.distinctAlertMessages.size > 0){
                    issueCell.title = `ë°œìƒ ë©”ì‹œì§€: ${Array.from(summary.distinctAlertMessages).join(' | ')}`;
                }

                const statusCell = row.insertCell();
                statusCell.textContent = summary.lastStatus || 'N/A';
                statusCell.style.color = statusColor;
                statusCell.style.fontWeight = 'bold';
            });
        }

        function updateTimestamp() {
            const timestampEl = document.getElementById('timestamp');
            if (timestampEl) {
                const now = new Date();
                const dataEndTime = allServerData && allServerData.length > 0 ? new Date(Math.max(...allServerData.map(d => new Date(d.timestamp).getTime()))) : now;
                timestampEl.textContent = `ë°ì´í„° ê¸°ì¤€ ì‹œê°: ${dataEndTime.toLocaleString('ko-KR', { year: 'numeric', month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false })}`;
            }
        }

        function setupEventListeners() {
            const applyBtn = document.getElementById('apply-filter-btn');
            if (applyBtn) applyBtn.addEventListener('click', applyAndRenderFilters);
            
            const csvBtn = document.getElementById('download-csv-btn');
            if (csvBtn) csvBtn.addEventListener('click', downloadSummaryCSV);
        }

        function downloadSummaryCSV() {
            showLoading();
            try {
                if (!dataProcessor) {
                    alert("ë°ì´í„°ê°€ ë¡œë“œë˜ì§€ ì•Šì•„ CSVë¥¼ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    hideLoading();
                    return;
                }
                const timeRange = document.getElementById('time-filter').value;
                const serverType = document.getElementById('server-type-filter').value;
                const alertValue = document.getElementById('alert-filter').value;
                const location = document.getElementById('location-filter').value;

                const filteredData = dataProcessor.applyFilters(parseInt(timeRange), serverType, alertValue, location);
                const serversForCsv = dataProcessor.getAlertSummaryByServer(filteredData);

                let csvContent = "ì„œë²„ í˜¸ìŠ¤íŠ¸ë„¤ì„,ì„œë²„ ìœ í˜•,ìœ„ì¹˜,Critical,Error,Warning,Info,ì£¼ìš” ê²½ê³  ë‚´ìš©,ìµœê·¼ ìƒíƒœ\n";
                serversForCsv.forEach(s => {
                    csvContent += `"${s.name || ''}","${s.type || ''}","${s.location || ''}",${s.criticalCount || 0},${s.errorCount || 0},${s.warningCount || 0},${s.infoCount || 0},"${(s.mainIssueMessage || '').replace(/"/g, '""')}","${s.lastStatus || ''}"\n`;
                });

                const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", `OpenManager_ì„œë²„ìš”ì•½_${new Date().toISOString().slice(0,10)}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (error) {
                console.error('CSV ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                alert('CSV íŒŒì¼ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                hideLoading();
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            showLoading(); // DOM ë¡œë“œ ì‹œì‘ ì‹œ ë¡œë”© í‘œì‹œ
            try {
                if (typeof getFixedDummyData !== 'function') {
                    console.error("getFixedDummyData is not defined! fixed_dummy_data.jsë¥¼ í™•ì¸í•˜ì„¸ìš”.");
                    alert("í•„ìˆ˜ ë°ì´í„° íŒŒì¼ì„ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: getFixedDummyData");
                    hideLoading();
                    return;
                }
                allServerData = getFixedDummyData();
                console.log(`ê³ ì • ë”ë¯¸ ë°ì´í„° ${allServerData.length}ê°œ ë¡œë“œ ì™„ë£Œ.`);

                if (!allServerData || allServerData.length === 0) {
                     alert("ë¡œë“œëœ ì„œë²„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                     hideLoading();
                     return;
                }
                
                if (typeof ServerDataProcessor !== 'function') { // ServerDataProcessor ì •ì˜ í™•ì¸
                    console.error("ServerDataProcessor is not defined! data_processor.jsë¥¼ í™•ì¸í•˜ì„¸ìš”.");
                    alert("í•„ìˆ˜ ë°ì´í„° ì²˜ë¦¬ ëª¨ë“ˆì„ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ServerDataProcessor");
                    hideLoading();
                    return;
                }
                dataProcessor = new ServerDataProcessor(allServerData);
                console.log('DataProcessor ì´ˆê¸°í™” ì™„ë£Œ.');
                
                initializeFilters();
                applyAndRenderFilters(); // ì´ í•¨ìˆ˜ ë‚´ë¶€ì˜ finallyì—ì„œ hideLoading() í˜¸ì¶œ
                setupEventListeners();

            } catch (error) {
                console.error('í˜ì´ì§€ ì´ˆê¸°í™” ì¤‘ ì‹¬ê°í•œ ì˜¤ë¥˜ ë°œìƒ:', error);
                alert('í˜ì´ì§€ë¥¼ ì´ˆê¸°í™”í•˜ëŠ” ì¤‘ ì‹¬ê°í•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                hideLoading(); // ì˜ˆì™¸ ë°œìƒ ì‹œ í™•ì‹¤í•˜ê²Œ ë¡œë”© ìˆ¨ê¹€
            }
            // applyAndRenderFilters í•¨ìˆ˜ê°€ ë¹„ë™ê¸°(setTimeout)ì´ë¯€ë¡œ,
            // ì—¬ê¸°ì„œ hideLoading()ì„ í˜¸ì¶œí•˜ë©´ í…Œì´ë¸”ì´ ê·¸ë ¤ì§€ê¸° ì „ì— ë¡œë”©ì´ ì‚¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            // applyAndRenderFilters ë‚´ë¶€ì˜ finallyì—ì„œ ì œì–´í•˜ëŠ” ê²ƒì´ ë” ì ì ˆí•©ë‹ˆë‹¤.
        });
    </script>
</body>
</html>
